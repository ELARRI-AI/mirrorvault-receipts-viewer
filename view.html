<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MirrorVault — Verified Receipt</title>

  <style>
    /* ——— Base MirrorStyle ——— */
    body{
      font-family: ui-serif,"Crimson Pro",Georgia,serif;
      background:#f9f6f1; color:#1a1a1a; margin:0;
    }
    .wrap{
      max-width:860px; margin:2rem auto; padding:1.5rem;
      background:#fff; border:1px solid #d6b168; border-radius:12px;
    }
    h1{ color:#d6b168; margin:0 0 .75rem; }
    .grid{ display:grid; grid-template-columns:1fr 1fr; gap:1.25rem; }
    .card{ border:1px solid #eee; border-left:4px solid #d6b168; padding:1.15rem; border-radius:8px; background:#fff; }
    .card h3{ margin:0 0 .6rem; }
    .k{ display:inline-block; min-width:9.5rem; color:#555; font-weight:600; }
    code{ background:#faf8f3; padding:.14rem .35rem; border-radius:4px; }
    .badge{
      display:inline-block; margin-right:.6rem; margin-top:.25rem;
      padding:.2rem .6rem; border-radius:6px; font-weight:700;
      background:#e8f6e8; color:#1f7a1f; border:1px solid #1f7a1f;
      vertical-align:middle;
    }
    .badge.warn{ background:#fff7e6; color:#9b6b00; border-color:#9b6b00; }
    .badge.fail{ background:#fdeaea; color:#9b1c1c; border-color:#9b1c1c; }

    /* Verified pulse */
    @keyframes verifiedPulse{
      0%,100%{ box-shadow:0 0 0 0 rgba(31,122,31,.28); }
      50%{ box-shadow:0 0 12px 4px rgba(31,122,31,.55); }
    }
    .badge.ok{ animation: verifiedPulse 3s ease-in-out infinite; }

    /* Copy button */
    .copy-cta{
      display:inline-block; padding:.45rem .8rem; background:#d6b168; color:#1a1a1a;
      font-weight:600; border:0; border-radius:6px; cursor:pointer;
      transition: transform .2s ease, box-shadow .2s ease; vertical-align:middle;
    }
    .copy-cta:hover{ transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,.12); }

    /* Wrapping for long values */
    .break, code, a{ word-break: break-word; overflow-wrap:anywhere; }
    #metaBlock p{ margin:.25rem 0; line-height:1.35; }
    #anchors, #attestations{ margin:.35rem 0 .15rem 1.2rem; }
    #anchors li, #attestations li{ margin:.25rem 0; }

    details summary{ cursor:pointer; }
    details[open] summary{ color:#444; }

    /* Fade-in reveal */
    .fadein{ opacity:0; transition:opacity .45s ease-in; }
    .fadein.visible{ opacity:1; }

    /* Mobile harmony */
    @media (max-width:720px){
      .wrap{ padding-left:1rem; padding-right:1rem; }
      .grid{ grid-template-columns:1fr; }
      .k{ min-width:7.5rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MirrorVault Verified Receipt</h1>
    <div id="statusBadge" class="badge">Checking…</div>
    <button id="copyLink" class="copy-cta" type="button" aria-label="Copy verification link">Copy Verification Link</button>
    <p id="subtitle" class="k"></p>

    <div class="grid">
      <section class="card">
        <h3>Receipt</h3>
        <p><span class="k">Receipt ID:</span> <span id="receipt_id">—</span></p>
        <p><span class="k">Subject:</span> <span id="subject">—</span></p>
        <p><span class="k">Content Digest:</span> <code id="digest">—</code></p>
        <p><span class="k">Created:</span> <span id="created_at">—</span></p>
        <div id="metaBlock"></div>
      </section>

      <section class="card">
        <h3>Seal</h3>
        <p><span class="k">Algorithm:</span> <span id="alg">—</span></p>
        <p><span class="k">Issuer:</span> <span id="issuer">—</span></p>
        <p><span class="k">Key ID:</span> <span id="key_id">—</span></p>
        <p><span class="k">Issued At:</span> <span id="issued_at">—</span></p>
        <details><summary>Signature</summary><code id="sig">—</code></details>
      </section>

      <section class="card">
        <h3>Anchors</h3>
        <ul id="anchors"><li>No anchors attached.</li></ul>
      </section>

      <section class="card">
        <h3>Attestations</h3>
        <ul id="attestations"><li>None.</li></ul>
      </section>
    </div>

    <div id="error" role="alert" style="color:#9b1c1c;font-weight:600;display:none;margin-top:.5rem"></div>
    <div class="k" style="text-align:center;margin-top:1rem">Seal ID <span id="sealId">—</span></div>
  </div>

  <!-- Viewer logic -->
  <script>
  // ===== MirrorVault Viewer — Full Drop-in Script (consolidated) =====
  const CONFIG = {
    API_BASE: "https://verify.mirrorvault.ai",
    VERIFY_BASE: "https://api.mirrorvault.ai",
    RECEIPT_ID: null,
    INCLUDE: "chain,attestations"
  };

  // helpers
  function deriveReceiptId(){
    const qp = new URLSearchParams(location.search);
    if (qp.get("id")) return qp.get("id");
    const m = location.pathname.match(/(rcpt_[A-Za-z0-9_]+)/);
    return m ? m[1] : null;
  }
  function safeText(x){ return (x===undefined || x===null || x==="") ? "—" : String(x); }
  function setBadge(status, text){
    const el = document.getElementById("statusBadge"); if(!el) return;
    el.className = "badge";
    if (status==="ok") el.classList.add("ok");
    else if (status==="warn") el.classList.add("warn");
    else if (status==="fail") el.classList.add("fail");
    el.textContent = text;
  }

  // data fetchers
  async function fetchReceipt(id){
    const rid = id || deriveReceiptId();

    // rcpt_demo* → local demo
    if (!rid || /^rcpt_demo/i.test(rid)) {
      const candidates = [`/receipts/${encodeURIComponent(rid || "rcpt_demo")}.json`, `/receipts/demo.json`];
      for (const url of candidates){
        try {
          const res = await fetch(url, { headers:{ "Accept":"application/json" }});
          if (res.ok){
            const data = await res.json();
            if (rid && data?.receipt) data.receipt.receipt_id = rid;
            window.currentReceiptId = rid || "rcpt_demo";
            return data;
          }
        } catch(_){}
      }
      throw new Error("Demo receipt JSON not found (checked /receipts/<id>.json and /receipts/demo.json).");
    }

    // else hit future API; fallback to demo
    try {
      const url = new URL(`${CONFIG.API_BASE}/v1/getReceipt/${encodeURIComponent(rid)}`);
      if (CONFIG.INCLUDE) url.searchParams.set("include", CONFIG.INCLUDE);
      url.searchParams.set("format", "json");
      const res = await fetch(url.toString(), { headers:{ "Accept":"application/json" }});
      if (!res.ok) throw new Error(`getReceipt failed: ${res.status}`);
      window.currentReceiptId = rid;
      return await res.json();
    } catch (e){
      const res = await fetch("/receipts/demo.json", { headers:{ "Accept":"application/json" }});
      if (!res.ok) throw e;
      const data = await res.json();
      window.currentReceiptId = "rcpt_demo";
      return data;
    }
  }

  // verify — demo short-circuit returns GREEN so pulse shows
  async function verifySeal(content_digest, seal){
    if (/^rcpt_demo/i.test((window.currentReceiptId || deriveReceiptId() || ""))) {
      return { ok:true, results:{ sig:"pass", issuer:"pass", expiry:"pass", transparency:"pass", anchors:{} }, warnings:[], verifier_version:"demo" };
    }
    const url = `${CONFIG.VERIFY_BASE}/v1/verifySeal`;
    const body = {
      content_digest,
      seal: { alg: seal.alg, sig: seal.sig, issuer: seal.issuer, key_id: seal.key_id, issued_at: seal.issued_at },
      checks: ["sig","issuer","expiry","transparency","anchors"]
    };
    const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    if (!res.ok) throw new Error(`verifySeal failed: ${res.status}`);
    return res.json();
  }

  // renderers
  function renderReceipt(bundle){
    const r = bundle.receipt || bundle;

    [["receipt_id","receipt_id"],["subject","subject"],["created_at","created_at"]].forEach(([id,key])=>{
      const el = document.getElementById(id); if (el) el.textContent = safeText(r[key]);
    });
    document.getElementById("digest")?.classList.add("break");
    const digestEl = document.getElementById("digest"); if (digestEl) digestEl.textContent = safeText(r.content_digest);
    const sealIdEl = document.getElementById("sealId"); if (sealIdEl) sealIdEl.textContent = safeText(r.receipt_id);

    const s = r.seal || {};
    [["alg","alg"],["issuer","issuer"],["key_id","key_id"],["issued_at","issued_at"]].forEach(([id,key])=>{
      const el = document.getElementById(id); if (el) el.textContent = safeText(s[key]);
    });
    const sigEl = document.getElementById("sig"); if (sigEl) sigEl.textContent = safeText(s.sig);

    const subtitle = document.getElementById("subtitle");
    if (subtitle && r.verification_url){
      const url = r.verification_url;
      subtitle.innerHTML = `<a class="break" href="${url}" target="_blank" rel="noopener">${url}</a>`;
    }

    // Meta
    const metaDiv = document.getElementById("metaBlock");
    if (metaDiv){
      const { actor, jurisdiction, consent_tier, tags, actor_name, document_title, document_uri } = r.meta || {};
      metaDiv.innerHTML = `
        <p><span class="k">Actor:</span> ${safeText(actor)} ${actor_name ? `&mdash; ${safeText(actor_name)}` : ""}</p>
        <p><span class="k">Jurisdiction:</span> ${safeText(jurisdiction)}</p>
        <p><span class="k">Consent Tier:</span> ${safeText(consent_tier)}</p>
        <p><span class="k">Title:</span> ${safeText(document_title || "—")}</p>
        <p><span class="k">Source:</span> ${document_uri ? `<a class="break" href="${document_uri}" target="_blank" rel="noopener">${document_uri}</a>` : "—"}</p>
        <p><span class="k">Tags:</span> ${Array.isArray(tags) ? tags.join(", ") : "—"}</p>
      `;
    }

    // Anchors
    const anchorsUL = document.getElementById("anchors");
    if (anchorsUL){
      anchorsUL.innerHTML = "";
      const a = (s.anchors || {});
      const rows = [
        ["timechain_tx", a.timechain_tx],
        ["transparency_log_id", a.transparency_log_id],
        ["notary_ref", a.notary_ref],
        ["witness_hash", a.witness_hash]
      ];
      let any = false;
      rows.forEach(([label,val])=>{
        if (val){
          any = true;
          const li = document.createElement("li");
          li.innerHTML = `<span class="k">${label}:</span> <code class="break">${val}</code>`;
          anchorsUL.appendChild(li);
        }
      });
      if (!any) anchorsUL.innerHTML = "<li>No anchors attached.</li>";
    }

    // Attestations
    const att = document.getElementById("attestations");
    const list = bundle.attestations || r.attestations || [];
    if (att){
      att.innerHTML = "";
      if (!list.length) att.innerHTML = "<li>None.</li>";
      else list.forEach(x=>{
        const extra = [x.jurisdiction, x.review_method].filter(Boolean).join(" · ");
        const li = document.createElement("li");
        li.innerHTML = `<strong>${safeText(x.type)}</strong> — ${safeText(x.status)} ${extra ? `(${extra})` : ""}`;
        att.appendChild(li);
      });
    }
  }

  function classifyResult(vr){
    if (!vr || typeof vr !== "object") return {status:"warn", text:"⚠ Verification unknown"};
    const { results } = vr;
    for (const k of ["sig","issuer","expiry","transparency"])
      if (results?.[k] === "fail") return {status:"fail", text:"✗ Verification failed"};
    if (results?.anchors){
      for (const k in results.anchors){
        const v = results.anchors[k];
        if (v === "fail" || v === "warn") return {status:"warn", text:"⚠ Anchor pending/warn"};
      }
    }
    return {status:"ok", text:"✓ Verified"};
  }

  // main
  (async function main(){
    try{
      const rid = CONFIG.RECEIPT_ID || deriveReceiptId();
      const bundle = await fetchReceipt(rid);

      // Render
      renderReceipt(bundle);

      // Fade-in blocks
      document.querySelectorAll('.wrap, .grid, .card').forEach(el=>{
        el.classList.add('fadein');
        setTimeout(()=>el.classList.add('visible'), 120);
      });

      // Copy link
      const copyBtn = document.getElementById('copyLink');
      if (copyBtn){
        copyBtn.addEventListener('click', async ()=>{
          try{
            await navigator.clipboard.writeText(window.location.href);
            const prev = copyBtn.textContent;
            copyBtn.textContent = 'Link Copied ✓';
            setTimeout(()=> copyBtn.textContent = prev, 1400);
          }catch{ alert('Could not copy link'); }
        });
      }

      // Verify (demo returns ok)
      const r = bundle.receipt || bundle;
      const seal = r.seal || {};
      let vr;
      try{ vr = await verifySeal(r.content_digest, seal); }
      catch(e){
        vr = { ok:false, results:{ sig:"warn", issuer:"warn", expiry:"warn", transparency:"warn", anchors:{} }, warnings:["verifier unreachable"], verifier_version:"demo-fallback" };
      }
      const verdict = classifyResult(vr);
      setBadge(verdict.status, verdict.text);

    }catch(err){
      console.error(err);
      const errEl = document.getElementById("error");
      if (errEl){ errEl.style.display = "block"; errEl.textContent = "Error: " + err.message; }
      setBadge("fail", "✗ Could not verify");
    }
  })();
  </script>
</body>
</html>
