<script>
// ===== MirrorVault Viewer — Clean Drop-in Script (JS only) =====

// Launch config (demo points to same host; switch VERIFY_BASE later)
const CONFIG = {
  API_BASE: "https://verify.mirrorvault.ai",  // serves /receipts/*.json for demo
  VERIFY_BASE: "https://api.mirrorvault.ai",  // real verifier later
  RECEIPT_ID: null,
  INCLUDE: "chain,attestations"
};

// ---------- helpers ----------
function deriveReceiptId() {
  const qp = new URLSearchParams(location.search);
  if (qp.get("id")) return qp.get("id");
  const m = location.pathname.match(/(rcpt_[A-Za-z0-9_]+)/);
  return m ? m[1] : null;
}
function safeText(x){ return (x===undefined || x===null || x==="") ? "—" : String(x); }
function setBadge(status, text) {
  const el = document.getElementById("statusBadge");
  if (!el) return;
  el.className = "badge";
  if (status === "ok") el.classList.add("ok");
  else if (status === "warn") el.classList.add("warn");
  else if (status === "fail") el.classList.add("fail");
  el.textContent = text;
}

// ---------- data fetchers ----------
async function fetchReceipt(id) {
  const rid = id || deriveReceiptId();

  // Treat any rcpt_demo* as local demo
  if (!rid || /^rcpt_demo/i.test(rid)) {
    const candidates = [
      `/receipts/${encodeURIComponent(rid || "rcpt_demo")}.json`,
      `/receipts/demo.json`
    ];
    for (const url of candidates) {
      try {
        const res = await fetch(url, { headers: { "Accept":"application/json" }});
        if (res.ok) {
          const data = await res.json();
          if (rid && data?.receipt) data.receipt.receipt_id = rid; // pretty ID on page
          window.currentReceiptId = rid || "rcpt_demo";
          return data;
        }
      } catch(_) {}
    }
    throw new Error("Demo receipt JSON not found (checked /receipts/<id>.json and /receipts/demo.json).");
  }

  // Otherwise hit the (future) live API; fall back to demo if not ready
  try {
    const url = new URL(`${CONFIG.API_BASE}/v1/getReceipt/${encodeURIComponent(rid)}`);
    if (CONFIG.INCLUDE) url.searchParams.set("include", CONFIG.INCLUDE);
    url.searchParams.set("format", "json");
    const res = await fetch(url.toString(), { headers: { "Accept": "application/json" }});
    if (!res.ok) throw new Error(`getReceipt failed: ${res.status}`);
    window.currentReceiptId = rid;
    return await res.json();
  } catch (e) {
    // graceful fallback
    const res = await fetch("/receipts/demo.json", { headers: { "Accept":"application/json" }});
    if (!res.ok) throw e;
    const data = await res.json();
    window.currentReceiptId = "rcpt_demo";
    return data;
  }
}

async function verifySeal(content_digest, seal) {
  // Short-circuit demo receipts (uncomment to force green badge)
  /*
  if (/^rcpt_demo/i.test((window.currentReceiptId || deriveReceiptId() || ""))) {
    return { ok: true, results: { sig:"pass", issuer:"pass", expiry:"pass", transparency:"pass", anchors:{} }, warnings: [], verifier_version: "demo" };
  }
  */
  const url = `${CONFIG.VERIFY_BASE}/v1/verifySeal`;
  const body = {
    content_digest,
    seal: { alg: seal.alg, sig: seal.sig, issuer: seal.issuer, key_id: seal.key_id, issued_at: seal.issued_at },
    checks: ["sig","issuer","expiry","transparency","anchors"]
  };
  const res = await fetch(url, { method:"POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(body) });
  if
